(()=>{function e(e){return e&&e.__esModule?e.default:e}var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},n={},i={},r=t.parcelRequirec4c6;null==r&&((r=function(e){if(e in n)return n[e].exports;if(e in i){var t=i[e];delete i[e];var r={id:e,exports:{}};return n[e]=r,t.call(r.exports,r,r.exports),r.exports}var s=new Error("Cannot find module '"+e+"'");throw s.code="MODULE_NOT_FOUND",s}).register=function(e,t){i[e]=t},t.parcelRequirec4c6=r),r.register("gj6Et",(function(e,t){!function(e,t,n){function i(e){var t=this,n=function(){var e=4022871197,t=function(t){t=t.toString();for(var n=0;n<t.length;n++){var i=.02519603282416938*(e+=t.charCodeAt(n));i-=e=i>>>0,e=(i*=e)>>>0,e+=4294967296*(i-=e)}return 2.3283064365386963e-10*(e>>>0)};return t}();t.next=function(){var e=2091639*t.s0+2.3283064365386963e-10*t.c;return t.s0=t.s1,t.s1=t.s2,t.s2=e-(t.c=0|e)},t.c=1,t.s0=n(" "),t.s1=n(" "),t.s2=n(" "),t.s0-=n(e),t.s0<0&&(t.s0+=1),t.s1-=n(e),t.s1<0&&(t.s1+=1),t.s2-=n(e),t.s2<0&&(t.s2+=1),n=null}function r(e,t){return t.c=e.c,t.s0=e.s0,t.s1=e.s1,t.s2=e.s2,t}function s(e,t){var n=new i(e),s=t&&t.state,o=n.next;return o.int32=function(){return 4294967296*n.next()|0},o.double=function(){return o()+11102230246251565e-32*(2097152*o()|0)},o.quick=o,s&&("object"==typeof s&&r(s,n),o.state=function(){return r(n,{})}),o}t&&t.exports?t.exports=s:n&&n.amd?n((function(){return s})):this.alea=s}(0,e,"function"==typeof define&&define)})),r.register("4gDjz",(function(e,t){!function(e,t,n){function i(e){var t=this,n="";t.x=0,t.y=0,t.z=0,t.w=0,t.next=function(){var e=t.x^t.x<<11;return t.x=t.y,t.y=t.z,t.z=t.w,t.w^=t.w>>>19^e^e>>>8},e===(0|e)?t.x=e:n+=e;for(var i=0;i<n.length+64;i++)t.x^=0|n.charCodeAt(i),t.next()}function r(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}function s(e,t){var n=new i(e),s=t&&t.state,o=function(){return(n.next()>>>0)/4294967296};return o.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/2097152}while(0===e);return e},o.int32=n.next,o.quick=o,s&&("object"==typeof s&&r(s,n),o.state=function(){return r(n,{})}),o}t&&t.exports?t.exports=s:n&&n.amd?n((function(){return s})):this.xor128=s}(0,e,"function"==typeof define&&define)})),r.register("HLBv4",(function(e,t){!function(e,t,n){function i(e){var t=this,n="";t.next=function(){var e=t.x^t.x>>>2;return t.x=t.y,t.y=t.z,t.z=t.w,t.w=t.v,(t.d=t.d+362437|0)+(t.v=t.v^t.v<<4^e^e<<1)|0},t.x=0,t.y=0,t.z=0,t.w=0,t.v=0,e===(0|e)?t.x=e:n+=e;for(var i=0;i<n.length+64;i++)t.x^=0|n.charCodeAt(i),i==n.length&&(t.d=t.x<<10^t.x>>>4),t.next()}function r(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t.v=e.v,t.d=e.d,t}function s(e,t){var n=new i(e),s=t&&t.state,o=function(){return(n.next()>>>0)/4294967296};return o.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/2097152}while(0===e);return e},o.int32=n.next,o.quick=o,s&&("object"==typeof s&&r(s,n),o.state=function(){return r(n,{})}),o}t&&t.exports?t.exports=s:n&&n.amd?n((function(){return s})):this.xorwow=s}(0,e,"function"==typeof define&&define)})),r.register("ktaoY",(function(e,t){!function(e,t,n){function i(e){var t=this;t.next=function(){var e,n,i=t.x,r=t.i;return e=i[r],n=(e^=e>>>7)^e<<24,n^=(e=i[r+1&7])^e>>>10,n^=(e=i[r+3&7])^e>>>3,n^=(e=i[r+4&7])^e<<7,e=i[r+7&7],n^=(e^=e<<13)^e<<9,i[r]=n,t.i=r+1&7,n},function(e,t){var n,i=[];if(t===(0|t))i[0]=t;else for(t=""+t,n=0;n<t.length;++n)i[7&n]=i[7&n]<<15^t.charCodeAt(n)+i[n+1&7]<<13;for(;i.length<8;)i.push(0);for(n=0;n<8&&0===i[n];++n);for(8==n?i[7]=-1:i[n],e.x=i,e.i=0,n=256;n>0;--n)e.next()}(t,e)}function r(e,t){return t.x=e.x.slice(),t.i=e.i,t}function s(e,t){null==e&&(e=+new Date);var n=new i(e),s=t&&t.state,o=function(){return(n.next()>>>0)/4294967296};return o.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/2097152}while(0===e);return e},o.int32=n.next,o.quick=o,s&&(s.x&&r(s,n),o.state=function(){return r(n,{})}),o}t&&t.exports?t.exports=s:n&&n.amd?n((function(){return s})):this.xorshift7=s}(0,e,"function"==typeof define&&define)})),r.register("gBs5C",(function(e,t){!function(e,t,n){function i(e){var t=this;t.next=function(){var e,n,i=t.w,r=t.X,s=t.i;return t.w=i=i+1640531527|0,n=r[s+34&127],e=r[s=s+1&127],n^=n<<13,e^=e<<17,n^=n>>>15,e^=e>>>12,n=r[s]=n^e,t.i=s,n+(i^i>>>16)|0},function(e,t){var n,i,r,s,o,c=[],l=128;for(t===(0|t)?(i=t,t=null):(t+="\0",i=0,l=Math.max(l,t.length)),r=0,s=-32;s<l;++s)t&&(i^=t.charCodeAt((s+32)%t.length)),0===s&&(o=i),i^=i<<10,i^=i>>>15,i^=i<<4,i^=i>>>13,s>=0&&(o=o+1640531527|0,r=0==(n=c[127&s]^=i+o)?r+1:0);for(r>=128&&(c[127&(t&&t.length||0)]=-1),r=127,s=512;s>0;--s)i=c[r+34&127],n=c[r=r+1&127],i^=i<<13,n^=n<<17,i^=i>>>15,n^=n>>>12,c[r]=i^n;e.w=o,e.X=c,e.i=r}(t,e)}function r(e,t){return t.i=e.i,t.w=e.w,t.X=e.X.slice(),t}function s(e,t){null==e&&(e=+new Date);var n=new i(e),s=t&&t.state,o=function(){return(n.next()>>>0)/4294967296};return o.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/2097152}while(0===e);return e},o.int32=n.next,o.quick=o,s&&(s.X&&r(s,n),o.state=function(){return r(n,{})}),o}t&&t.exports?t.exports=s:n&&n.amd?n((function(){return s})):this.xor4096=s}(0,e,"function"==typeof define&&define)})),r.register("ktLSh",(function(e,t){!function(e,t,n){function i(e){var t=this,n="";t.next=function(){var e=t.b,n=t.c,i=t.d,r=t.a;return e=e<<25^e>>>7^n,n=n-i|0,i=i<<24^i>>>8^r,r=r-e|0,t.b=e=e<<20^e>>>12^n,t.c=n=n-i|0,t.d=i<<16^n>>>16^r,t.a=r-e|0},t.a=0,t.b=0,t.c=-1640531527,t.d=1367130551,e===Math.floor(e)?(t.a=e/4294967296|0,t.b=0|e):n+=e;for(var i=0;i<n.length+20;i++)t.b^=0|n.charCodeAt(i),t.next()}function r(e,t){return t.a=e.a,t.b=e.b,t.c=e.c,t.d=e.d,t}function s(e,t){var n=new i(e),s=t&&t.state,o=function(){return(n.next()>>>0)/4294967296};return o.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/2097152}while(0===e);return e},o.int32=n.next,o.quick=o,s&&("object"==typeof s&&r(s,n),o.state=function(){return r(n,{})}),o}t&&t.exports?t.exports=s:n&&n.amd?n((function(){return s})):this.tychei=s}(0,e,"function"==typeof define&&define)})),r.register("foUwZ",(function(e,t){}));
/* @license BML - BSD 3 Clause License - Source at github.com/ajyoon/bml - Docs at bml-lang.org */var s,o=r("gj6Et"),c=r("4gDjz"),l=r("HLBv4"),u=r("ktaoY"),a=r("gBs5C"),h=r("ktLSh"),f={};!function(e,t){var n,i=(0,eval)("this"),s=256,o="random",c=t.pow(s,6),l=t.pow(2,52),u=2*l,a=255;function h(r,a,h){var f=[],g=p(E((a=1==a?{entropy:!0}:a||{}).entropy?[r,w(e)]:null==r?function(){try{var t;return n&&(t=n.randomBytes)?t=t(s):(t=new Uint8Array(s),(i.crypto||i.msCrypto).getRandomValues(t)),w(t)}catch(t){var r=i.navigator,o=r&&r.plugins;return[+new Date,i,o,i.screen,w(e)]}}():r,3),f),C=new d(f),O=function(){for(var e=C.g(6),t=c,n=0;e<l;)e=(e+n)*s,t*=s,n=C.g(1);for(;e>=u;)e/=2,t/=2,n>>>=1;return(e+n)/t};return O.int32=function(){return 0|C.g(4)},O.quick=function(){return C.g(4)/4294967296},O.double=O,p(w(C.S),e),(a.pass||h||function(e,n,i,r){return r&&(r.S&&x(r,C),e.state=function(){return x(C,{})}),i?(t[o]=e,n):e})(O,g,"global"in a?a.global:this==t,a.state)}function d(e){var t,n=e.length,i=this,r=0,o=i.i=i.j=0,c=i.S=[];for(n||(e=[n++]);r<s;)c[r]=r++;for(r=0;r<s;r++)c[r]=c[o=a&o+e[r%n]+(t=c[r])],c[o]=t;(i.g=function(e){for(var t,n=0,r=i.i,o=i.j,c=i.S;e--;)t=c[r=a&r+1],n=n*s+c[a&(c[r]=c[o=a&o+t])+(c[o]=t)];return i.i=r,i.j=o,n})(s)}function x(e,t){return t.i=e.i,t.j=e.j,t.S=e.S.slice(),t}function E(e,t){var n,i=[],r=typeof e;if(t&&"object"==r)for(n in e)try{i.push(E(e[n],t-1))}catch(e){}return i.length?i:"string"==r?e:e+"\0"}function p(e,t){for(var n,i=e+"",r=0;r<i.length;)t[a&r]=a&(n^=19*t[a&r])+i.charCodeAt(r++);return w(t)}function w(e){return String.fromCharCode.apply(0,e)}if(t["seed"+o]=h,p(t.random(),e),f){f=h;try{n=r("foUwZ")}catch(e){}}else"function"==typeof define&&define.amd&&define((function(){return h}))}([],Math),f.alea=o,f.xor128=c,f.xorwow=l,f.xorshift7=u,f.xor4096=a,f.tychei=h;let d=e(s=f)();function x(e){let t=[],n=0,i=0;for(let r=0;r<e.length;r++){let s=e[r];t.push(s.clone()),null===s.weight?i++:n+=s.weight}let r=(100-n)/i;for(let e=0;e<t.length;e++)null===t[e].weight&&(t[e].weight=r);return t}function E(e,t){return d()*(t-e)+e}function p(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(d()*(t-e))+e}function w(e){let t=0;for(let n of e)t+=n.weight??0;let n=0,i=E(0,t);for(let t=0;t<e.length;t++){let r=e[t];if(n+=r.weight??0,n>=i)return{choice:r.choice,choiceIndex:t}}console.warn("Unable to pick weighted choice for weights: "+e);let r=p(0,e.length);return{choice:e[r].choice,choiceIndex:r}}const g=/^\s*$/,C=/\s+$/;const O=/(\w)(\s+)([.,:;!?]+)/g;const _=/([.!?]\s+|^\s*)(\p{Ll})/gu;function N(e,t,n){return t+n.toUpperCase()}const b=/\\(\r?\n|\r)[ \t]*/g;const T={whitespaceCleanup:!0,punctuationCleanup:!0,capitalizationCleanup:!0},y={randomSeed:null,allowEval:!0};function k(e,t){return Object.assign({},e,t)}class S{constructor(e,t){this.choice=e,this.weight=t}toString(){return`WeightedChoice{choice: ${String(this.choice)}, weight: ${this.weight}}`}clone(){return new S(this.choice,this.weight)}}const v={WeightedChoice:S,weightedChoose:w,randomInt:p,randomFloat:E};function A(e,t){let n=function(e,t){if(t>e.length)throw new Error("charIndex > string.length");let n=1,i=-1,r=!1;for(let s=0;s<=t;s++)r?(n++,i=0,r=!1):i++,"\n"===e[s]&&(r=!0);return{line:n,column:i}}(e,t);return"line: "+n.line+", column: "+n.column}function L(e){return e instanceof String||"string"==typeof e}class R extends Error{constructor(e){super(e+" This is a bug. Please report at https://github.com/ajyoon/bml/issues"),this.name="IllegalStateError",Object.setPrototypeOf(this,R.prototype)}}class m extends Error{constructor(e,t){super("Syntax error found while parsing bml javascript at "+A(e,t)),this.name="JavascriptSyntaxError",Object.setPrototypeOf(this,m.prototype)}}class B extends Error{constructor(e,t,n){super((e||"Syntax error found while parsing bml")+" at "+A(t,n)),this.name="BMLSyntaxError",Object.setPrototypeOf(this,B.prototype)}}class M extends Error{constructor(e,t,n,i){super(`Duplicated reference index ${t} for reference ${e} at ${A(n,i)}`),this.name="BMLDuplicatedRefIndexError",Object.setPrototypeOf(this,M.prototype)}}class I extends Error{constructor(e,t,n){super(`Duplicated reference ${e} at ${A(t,n)}`),this.name="BMLDuplicatedRefError",Object.setPrototypeOf(this,I.prototype)}}class P extends Error{constructor(e,t){super(`Eval binding of settings field '${e}' of '${t}' is invalid`),this.name="EvalBoundSettingsError",Object.setPrototypeOf(this,P.prototype)}}class U extends Error{constructor(e){super(`Eval binding ${e} was bound multiple times.`),this.name="EvalBindingError",Object.setPrototypeOf(this,U.prototype)}}class K extends Error{constructor(){super("This document includes eval blocks and cannot be rendered with allowEval=false."),this.name="EvalDisabledError",Object.setPrototypeOf(this,K.prototype)}}function j(e,t,n){const i=e[t];if(null!=i&&typeof i!==n)throw new P("setting."+t,i)}function $(e){let t=e.settings;t&&(j(t,"whitespaceCleanup","boolean"),j(t,"punctuationCleanup","boolean"),j(t,"capitalizationCleanup","boolean"))}const W="\n  const bml = this;\n\n  const __new_bindings = {};\n\n  function bind(obj) {\n    for (let key in obj) {\n      __new_bindings[key] = obj[key];\n    }\n\n  }\n\n  ***USER DEFS BINDING SLOT***\n\n\n  function insert(str) {\n    __context.output += str;\n  }\n\n  ////////// start user code\n\n  ***USER CODE SLOT***\n\n  ////////// end user code\n\n  ***SAVE USER MUTATIONS SLOT***\n\n  return __new_bindings;\n";class D{constructor(e){this.contents=e}toString(){return`EvalBlock('${this.contents}')`}generateBindingCode(e){let t=[];e.settings&&t.push("let settings = __context.bindings.settings;");for(let n in e)t.push(`let ${n} = __context.bindings.${n}`);return t.join("\n")}generateSaveUserMutationsCode(e){let t=[];e.settings&&t.push("__context.bindings.settings = settings;");for(let n in e)t.push(`__context.bindings.${n} = ${n};`);return t.join("\n")}toFunc(e){let t=W.replace("***USER CODE SLOT***",this.contents);t=t.replace("***USER DEFS BINDING SLOT***",this.generateBindingCode(e)),t=t.replace("***SAVE USER MUTATIONS SLOT***",this.generateSaveUserMutationsCode(e));let n=Object.assign({},v);return new Function("__context",t).bind(n)}execute(e){let t=this.toFunc(e.bindings)(e);$(t);for(let[n,i]of Object.entries(t)){if(e.bindings.hasOwnProperty(n))throw new U(n);e.bindings[n]=i}}}let z;var q;(q=z||(z={})).WHITESPACE="WHITESPACE",q.NEW_LINE="NEW_LINE",q.VISUAL_NEW_LINE="VISUAL_NEW_LINE",q.COMMENT="COMMENT",q.OPEN_BLOCK_COMMENT="OPEN_BLOCK_COMMENT",q.CLOSE_BLOCK_COMMENT="CLOSE_BLOCK_COMMENT",q.SLASH="SLASH",q.SINGLE_QUOTE="SINGLE_QUOTE",q.DOUBLE_QUOTE="DOUBLE_QUOTE",q.BACKTICK="BACKTICK",q.OPEN_PAREN="OPEN_PAREN",q.CLOSE_PAREN="CLOSE_PAREN",q.OPEN_BRACE="OPEN_BRACE",q.CLOSE_BRACE="CLOSE_BRACE",q.OPEN_BRACKET="OPEN_BRACKET",q.CLOSE_BRACKET="CLOSE_BRACKET",q.COMMA="COMMA",q.COLON="COLON",q.AT="AT",q.ARROW="ARROW",q.NUMBER="NUMBER",q.TEXT="TEXT";class F{constructor(e,t,n){this.weights=x(e),this.identifier=t,this.isSilent=n}call(){let e=w(this.weights);return{replacement:e.choice,choiceIndex:e.choiceIndex}}toString(){return`ChoiceFork{weights: ${this.weights}, identifier: ${this.identifier}, isSilent: ${this.isSilent}}`}}class H{constructor(e,t,n){this.id=e,this.referenceMap=t,n.length?this.fallbackChoiceFork=new F(n,null,!1):this.fallbackChoiceFork=null}}function Q(e){if(e.next()?.tokenType!==z.OPEN_BRACKET)throw new R("parseEval started with non-OPEN_BRACKET");let t,n="code",i=e.index,r=1;for(;null!==(t=e.next());)switch(n){case"block comment":t.tokenType===z.CLOSE_BLOCK_COMMENT&&(n="code");break;case"inline comment":t.tokenType===z.NEW_LINE&&(n="code");break;case"template literal":t.tokenType===z.BACKTICK&&(n="code");break;case"single-quote string":if(t.tokenType===z.SINGLE_QUOTE)n="code";else if(t.tokenType===z.NEW_LINE)throw new m(e.str,e.index);break;case"double-quote string":if(t.tokenType===z.DOUBLE_QUOTE)n="code";else if(t.tokenType===z.NEW_LINE)throw new m(e.str,e.index);break;case"regexp literal":t.tokenType===z.SLASH&&(n="code");break;case"code":switch(t.tokenType){case z.OPEN_BRACKET:r++;break;case z.CLOSE_BRACKET:if(r--,r<1){let t=e.str.slice(i,e.index-1);return new D(t)}break;case z.COMMENT:n="inline comment";break;case z.OPEN_BLOCK_COMMENT:n="block comment";break;case z.BACKTICK:n="template literal";break;case z.SINGLE_QUOTE:n="single-quote string";break;case z.DOUBLE_QUOTE:n="double-quote string";break;case z.SLASH:n="regexp literal"}break;default:throw new Error(`Invalid state: ${n}`)}throw new m("could not find end of javascript code block",i)}function X(e){let t,n=e.index,i=new Map,r=[],s=/([@#]?)(\w+):?/y,o=null,c=!1,l=!1,u=!0,a=!1,h=!1,f=!1,d=!0,x=!1,E=!0,p=[],w=null;for(;null!==(t=e.peek());){switch(t.tokenType){case z.WHITESPACE:case z.NEW_LINE:break;case z.NUMBER:if(h)h=!1,f=!0,x=!0,p.push(Number(t.str));else{if(!a)throw new B("Unexpected number in fork",e.str,t.index);a=!1,x=!0,E=!0,r[r.length-1].weight=Number(t.str)}break;case z.ARROW:if(!f)throw new B("Unexpected arrow in fork",e.str,t.index);f=!1,d=!0,x=!1;break;case z.OPEN_PAREN:case z.OPEN_BRACKET:case z.OPEN_BRACE:if(!d)throw new B("Unexpected replacement in fork",e.str,t.index);if(h=!1,t.tokenType===z.OPEN_PAREN?(e.next(),w=V(e,!1)):t.tokenType===z.OPEN_BRACKET?w=Q(e):(e.next(),w=[X(e)]),p.length){for(let n of p){if(i.has(n))throw new M(o,n,e.str,t.index);i.set(n,w)}d=!1,x=!0,E=!0,p=[],w=null}else r.push(new S(w,null)),d=!1,x=!0,a=!0,E=!0;continue;case z.COMMA:if(!x)throw new B("Unexpected comma in fork",e.str,t.index);x=!1,h=!0,f||(d=!0);break;case z.CLOSE_BRACE:if(E)return e.next(),c?new H(o,i,r):new F(r,o,l);throw new B("Unexpected close brace in fork",e.str,t.index);case z.TEXT:case z.AT:if(u){s.lastIndex=e.index;let n=s.exec(e.str);if(!n)throw new B(`Unexpected token ${t}`,e.str,t.index);let i=n[1];o=n[2],"@"==i?(c=!0,h=!0):"#"==i&&(l=!0),e.overrideIndex(e.index+n[0].length),u=!1;continue}throw new B(`Unexpected token ${t}`,e.str,t.index);default:throw new B(`Unexpected token ${t}`,e.str,t.index)}e.next()}throw new B("Could not find end of fork.",e.str,n)}function G(e){let t,n=e.index-1;if(e.next()?.tokenType!==z.OPEN_BRACKET)throw new R("parseLiteralBlock started with non-OPEN_BRACKET");let i="";for(;null!==(t=e.next());){if(t.tokenType===z.CLOSE_BRACKET&&e.peek()?.tokenType==z.CLOSE_BRACKET)return e.next(),i;i+=t.str}throw new B("Could not find end of literal block",e.str,n)}function V(e,t){let n,i=e.index,r=1,s=[];function o(e){if(!s.length)return void s.push(e);let t=s[s.length-1];L(t)?s[s.length-1]=t.concat(e):s.push(e)}for(;null!==(n=e.next());)switch(n.tokenType){case z.OPEN_PAREN:r++;break;case z.CLOSE_PAREN:if(r--,r<1)return s;break;case z.OPEN_BRACKET:e.peek()?.tokenType==z.OPEN_BRACKET?o(G(e)):o(n.str);break;case z.OPEN_BRACE:let t=X(e);s=s.concat(t);break;default:o(n.str)}if(!t)throw new B("Reached end of document while parsing string.",e.str,i);return s}class Y{constructor(e,t,n,i){this.tokenType=e,this.index=t,this.endIndex=n,this.str=i}toString(){return`Token{tokenType: ${this.tokenType}, index: ${this.index}, endIndex: ${this.endIndex}, string: '${this.str}'}`}}const Z=/\s/;class J{_cachedNext=null;_newLineRe=/\r?\n/y;_whitespaceRe=/[^\S\r\n]+/y;_numberRe=/(\d+(\.\d+)?)|(\.\d+)/y;constructor(e){this.str=e,this.index=0}overrideIndex(e){this._cachedNext=null,this.index=e}_determineNextRaw(){if(this.index>=this.str.length)return null;let e,t,n=this.index,i=null;this._newLineRe.lastIndex=this.index,this._whitespaceRe.lastIndex=this.index,this._numberRe.lastIndex=this.index;let r=this._newLineRe.exec(this.str),s=this._whitespaceRe.exec(this.str),o=this._numberRe.exec(this.str);if(null!==r)e=z.NEW_LINE,t=r[0];else if(null!==s)e=z.WHITESPACE,t=s[0];else if(null!==o)e=z.NUMBER,t=o[0];else if("//"===this.str.slice(this.index,this.index+2))e=z.COMMENT,t="//";else if("/*"===this.str.slice(this.index,this.index+2))e=z.OPEN_BLOCK_COMMENT,t="/*";else if("*/"===this.str.slice(this.index,this.index+2))e=z.CLOSE_BLOCK_COMMENT,t="*/";else if("/"===this.str[this.index])e=z.SLASH,t="/";else if("'"===this.str[this.index])e=z.SINGLE_QUOTE,t="'";else if('"'===this.str[this.index])e=z.DOUBLE_QUOTE,t='"';else if("`"===this.str[this.index])e=z.BACKTICK,t="`";else if("("===this.str[this.index])e=z.OPEN_PAREN,t="(";else if(")"===this.str[this.index])e=z.CLOSE_PAREN,t=")";else if("{"===this.str[this.index])e=z.OPEN_BRACE,t="{";else if("}"===this.str[this.index])e=z.CLOSE_BRACE,t="}";else if(","===this.str[this.index])e=z.COMMA,t=",";else if(":"===this.str[this.index])e=z.COLON,t=":";else if("@"===this.str[this.index])e=z.AT,t="@";else if("["===this.str[this.index])e=z.OPEN_BRACKET,t="[";else if("]"===this.str[this.index])e=z.CLOSE_BRACKET,t="]";else if("->"===this.str.slice(this.index,this.index+2))e=z.ARROW,t="->";else if(e=z.TEXT,"\\"===this.str[this.index]){let e=this.str[this.index+1];"\\/[{])".includes(e)?(i=this.index+2,t=e):"n"===e?(i=this.index+2,t="\n"):"t"===e?(i=this.index+2,t="\t"):"r"===e?(i=this.index+2,t="\r"):t="\\"}else t=this.str[this.index];return null===i&&(i=n+t.length),new Y(e,n,i,t)}_determineNextReal(){let e,t=!1,n=!1,i=this.index;for(;null!==(e=this._determineNextRaw());){if(t){if(e.tokenType===z.NEW_LINE)return t=!1,new Y(z.NEW_LINE,e.index,e.endIndex,e.str)}else if(n){if(e.tokenType===z.CLOSE_BLOCK_COMMENT){let t=e.index+1;return new Y(z.WHITESPACE,t,t+1," ")}}else if(e.tokenType===z.COMMENT){let n=e.index>=this.str.length||Z.test(this.str[e.endIndex]);if(!(0===e.index||Z.test(this.str[e.index-1]))&&!n)return new Y(z.TEXT,e.index,e.endIndex,e.str);t=!0}else{if(e.tokenType!==z.OPEN_BLOCK_COMMENT)return this.index=i,e;n=!0}this.index=e.endIndex}return this.index=i,null}next(){let e;return null!==this._cachedNext?(e=this._cachedNext,this._cachedNext=null):e=this._determineNextReal(),this.index=null!==e?e.endIndex:this.str.length,e}peek(){if(null!==this._cachedNext)return this._cachedNext;let e=this._determineNextReal();return this._cachedNext=e,e}nextSatisfying(e){let t;for(;null!==(t=this.next());)if(e(t))return t;return null}nextNonWhitespace(){return this.nextSatisfying((e=>e.tokenType!==z.WHITESPACE&&e.tokenType!==z.NEW_LINE))}}class ee{constructor(e){this.settings=e,this.choiceResultMap=new Map,this.evalContext={bindings:{},output:""}}resolveReference(e){let t=this.choiceResultMap.get(e.id);if(t){if(!e.referenceMap.size&&!e.fallbackChoiceFork)return[t.renderedOutput];let n=e.referenceMap.get(t.choiceIndex);if(void 0!==n)return n}return e.fallbackChoiceFork?e.fallbackChoiceFork.call().replacement:(console.warn(`No matching reference or fallback found for ${e.id}`),[""])}renderChoice(e){if(e instanceof Array)return this.renderAst(e);{if(!this.settings.allowEval)throw new K;e.execute(this.evalContext);let t=this.evalContext.output;return this.evalContext.output="",t}}renderAst(e){let t="";for(let n=0;n<e.length;n++){let i=e[n];if(L(i))t+=i;else if(i instanceof F){let{replacement:r,choiceIndex:s}=i.call(),o=this.renderChoice(r);if(i.isSilent){if(t.length&&"\n"==t[t.length-1]){let t=n<e.length-1?e[n+1]:null;L(t)&&(t.startsWith("\n")?e[n+1]=t.slice(1):t.startsWith("\r\n")&&(e[n+1]=t.slice(2)))}}else t+=o;i.identifier&&this.choiceResultMap.set(i.identifier,{choiceIndex:s,renderedOutput:o})}else{let e=this.resolveReference(i);t+=this.renderChoice(e)}}return t}postprocess(e){let t=k(T,this.evalContext.bindings.settings),n=e;return n=function(e){return e.replace(b," ")}(n),t.punctuationCleanup&&(n=function(e){return e.replace(O,"$1$3$2")}(n)),t.capitalizationCleanup&&(n=function(e){return e.replace(_,N)}(n)),t.whitespaceCleanup&&(n=function(e){let t="",n=!0,i=!1;for(let r of e.split("\n")){let e=g.test(r);if(n){if(e)continue;n=!1}if(e){if(i)continue;r=""}else{r=r.replace(C,"");let e="",t=!0,n=!1;for(let i of r){let r=" "===i;!t&&n&&r||(r||(t=!1),e+=i,n=r)}r=e}i=e,t+=r+"\n"}return t.endsWith("\n\n")&&(t=t.substring(0,t.length-1)),t}(n)),n}renderAndPostProcess(t){var n;this.settings.randomSeed&&(n=this.settings.randomSeed,d=e(s)(n));let i=this.renderAst(t);return this.postprocess(i)}}window.bml=function(e,t){t=k(y,t);let n=V(new J(e),!0);return new ee(t).renderAndPostProcess(n)}})();
//# sourceMappingURL=bml.bundle.js.map
