(()=>{function e(e){return e&&e.__esModule?e.default:e}var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},n={},r={},i=t.parcelRequirec4c6;null==i&&((i=function(e){if(e in n)return n[e].exports;if(e in r){var t=r[e];delete r[e];var i={id:e,exports:{}};return n[e]=i,t.call(i.exports,i,i.exports),i.exports}var o=new Error("Cannot find module '"+e+"'");throw o.code="MODULE_NOT_FOUND",o}).register=function(e,t){r[e]=t},t.parcelRequirec4c6=i),i.register("gj6Et",(function(e,t){!function(e,t,n){function r(e){var t=this,n=function(){var e=4022871197,t=function(t){t=t.toString();for(var n=0;n<t.length;n++){var r=.02519603282416938*(e+=t.charCodeAt(n));r-=e=r>>>0,e=(r*=e)>>>0,e+=4294967296*(r-=e)}return 2.3283064365386963e-10*(e>>>0)};return t}();t.next=function(){var e=2091639*t.s0+2.3283064365386963e-10*t.c;return t.s0=t.s1,t.s1=t.s2,t.s2=e-(t.c=0|e)},t.c=1,t.s0=n(" "),t.s1=n(" "),t.s2=n(" "),t.s0-=n(e),t.s0<0&&(t.s0+=1),t.s1-=n(e),t.s1<0&&(t.s1+=1),t.s2-=n(e),t.s2<0&&(t.s2+=1),n=null}function i(e,t){return t.c=e.c,t.s0=e.s0,t.s1=e.s1,t.s2=e.s2,t}function o(e,t){var n=new r(e),o=t&&t.state,s=n.next;return s.int32=function(){return 4294967296*n.next()|0},s.double=function(){return s()+11102230246251565e-32*(2097152*s()|0)},s.quick=s,o&&("object"==typeof o&&i(o,n),s.state=function(){return i(n,{})}),s}t&&t.exports?t.exports=o:n&&n.amd?n((function(){return o})):this.alea=o}(0,e,"function"==typeof define&&define)})),i.register("4gDjz",(function(e,t){!function(e,t,n){function r(e){var t=this,n="";t.x=0,t.y=0,t.z=0,t.w=0,t.next=function(){var e=t.x^t.x<<11;return t.x=t.y,t.y=t.z,t.z=t.w,t.w^=t.w>>>19^e^e>>>8},e===(0|e)?t.x=e:n+=e;for(var r=0;r<n.length+64;r++)t.x^=0|n.charCodeAt(r),t.next()}function i(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}function o(e,t){var n=new r(e),o=t&&t.state,s=function(){return(n.next()>>>0)/4294967296};return s.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/2097152}while(0===e);return e},s.int32=n.next,s.quick=s,o&&("object"==typeof o&&i(o,n),s.state=function(){return i(n,{})}),s}t&&t.exports?t.exports=o:n&&n.amd?n((function(){return o})):this.xor128=o}(0,e,"function"==typeof define&&define)})),i.register("HLBv4",(function(e,t){!function(e,t,n){function r(e){var t=this,n="";t.next=function(){var e=t.x^t.x>>>2;return t.x=t.y,t.y=t.z,t.z=t.w,t.w=t.v,(t.d=t.d+362437|0)+(t.v=t.v^t.v<<4^e^e<<1)|0},t.x=0,t.y=0,t.z=0,t.w=0,t.v=0,e===(0|e)?t.x=e:n+=e;for(var r=0;r<n.length+64;r++)t.x^=0|n.charCodeAt(r),r==n.length&&(t.d=t.x<<10^t.x>>>4),t.next()}function i(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t.v=e.v,t.d=e.d,t}function o(e,t){var n=new r(e),o=t&&t.state,s=function(){return(n.next()>>>0)/4294967296};return s.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/2097152}while(0===e);return e},s.int32=n.next,s.quick=s,o&&("object"==typeof o&&i(o,n),s.state=function(){return i(n,{})}),s}t&&t.exports?t.exports=o:n&&n.amd?n((function(){return o})):this.xorwow=o}(0,e,"function"==typeof define&&define)})),i.register("ktaoY",(function(e,t){!function(e,t,n){function r(e){var t=this;t.next=function(){var e,n,r=t.x,i=t.i;return e=r[i],n=(e^=e>>>7)^e<<24,n^=(e=r[i+1&7])^e>>>10,n^=(e=r[i+3&7])^e>>>3,n^=(e=r[i+4&7])^e<<7,e=r[i+7&7],n^=(e^=e<<13)^e<<9,r[i]=n,t.i=i+1&7,n},function(e,t){var n,r=[];if(t===(0|t))r[0]=t;else for(t=""+t,n=0;n<t.length;++n)r[7&n]=r[7&n]<<15^t.charCodeAt(n)+r[n+1&7]<<13;for(;r.length<8;)r.push(0);for(n=0;n<8&&0===r[n];++n);for(8==n?r[7]=-1:r[n],e.x=r,e.i=0,n=256;n>0;--n)e.next()}(t,e)}function i(e,t){return t.x=e.x.slice(),t.i=e.i,t}function o(e,t){null==e&&(e=+new Date);var n=new r(e),o=t&&t.state,s=function(){return(n.next()>>>0)/4294967296};return s.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/2097152}while(0===e);return e},s.int32=n.next,s.quick=s,o&&(o.x&&i(o,n),s.state=function(){return i(n,{})}),s}t&&t.exports?t.exports=o:n&&n.amd?n((function(){return o})):this.xorshift7=o}(0,e,"function"==typeof define&&define)})),i.register("gBs5C",(function(e,t){!function(e,t,n){function r(e){var t=this;t.next=function(){var e,n,r=t.w,i=t.X,o=t.i;return t.w=r=r+1640531527|0,n=i[o+34&127],e=i[o=o+1&127],n^=n<<13,e^=e<<17,n^=n>>>15,e^=e>>>12,n=i[o]=n^e,t.i=o,n+(r^r>>>16)|0},function(e,t){var n,r,i,o,s,c=[],l=128;for(t===(0|t)?(r=t,t=null):(t+="\0",r=0,l=Math.max(l,t.length)),i=0,o=-32;o<l;++o)t&&(r^=t.charCodeAt((o+32)%t.length)),0===o&&(s=r),r^=r<<10,r^=r>>>15,r^=r<<4,r^=r>>>13,o>=0&&(s=s+1640531527|0,i=0==(n=c[127&o]^=r+s)?i+1:0);for(i>=128&&(c[127&(t&&t.length||0)]=-1),i=127,o=512;o>0;--o)r=c[i+34&127],n=c[i=i+1&127],r^=r<<13,n^=n<<17,r^=r>>>15,n^=n>>>12,c[i]=r^n;e.w=s,e.X=c,e.i=i}(t,e)}function i(e,t){return t.i=e.i,t.w=e.w,t.X=e.X.slice(),t}function o(e,t){null==e&&(e=+new Date);var n=new r(e),o=t&&t.state,s=function(){return(n.next()>>>0)/4294967296};return s.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/2097152}while(0===e);return e},s.int32=n.next,s.quick=s,o&&(o.X&&i(o,n),s.state=function(){return i(n,{})}),s}t&&t.exports?t.exports=o:n&&n.amd?n((function(){return o})):this.xor4096=o}(0,e,"function"==typeof define&&define)})),i.register("ktLSh",(function(e,t){!function(e,t,n){function r(e){var t=this,n="";t.next=function(){var e=t.b,n=t.c,r=t.d,i=t.a;return e=e<<25^e>>>7^n,n=n-r|0,r=r<<24^r>>>8^i,i=i-e|0,t.b=e=e<<20^e>>>12^n,t.c=n=n-r|0,t.d=r<<16^n>>>16^i,t.a=i-e|0},t.a=0,t.b=0,t.c=-1640531527,t.d=1367130551,e===Math.floor(e)?(t.a=e/4294967296|0,t.b=0|e):n+=e;for(var r=0;r<n.length+20;r++)t.b^=0|n.charCodeAt(r),t.next()}function i(e,t){return t.a=e.a,t.b=e.b,t.c=e.c,t.d=e.d,t}function o(e,t){var n=new r(e),o=t&&t.state,s=function(){return(n.next()>>>0)/4294967296};return s.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/2097152}while(0===e);return e},s.int32=n.next,s.quick=s,o&&("object"==typeof o&&i(o,n),s.state=function(){return i(n,{})}),s}t&&t.exports?t.exports=o:n&&n.amd?n((function(){return o})):this.tychei=o}(0,e,"function"==typeof define&&define)})),i.register("foUwZ",(function(e,t){}));
/* @license BML - BSD 3 Clause License - Source at github.com/ajyoon/bml - Docs at bml-lang.org */var o,s,c,l={},u=l={};function a(){throw new Error("setTimeout has not been defined")}function h(){throw new Error("clearTimeout has not been defined")}function f(e){if(s===setTimeout)return setTimeout(e,0);if((s===a||!s)&&setTimeout)return s=setTimeout,setTimeout(e,0);try{return s(e,0)}catch(t){try{return s.call(null,e,0)}catch(t){return s.call(this,e,0)}}}!function(){try{s="function"==typeof setTimeout?setTimeout:a}catch(e){s=a}try{c="function"==typeof clearTimeout?clearTimeout:h}catch(e){c=h}}();var d,p=[],x=!1,g=-1;function E(){x&&d&&(x=!1,d.length?p=d.concat(p):g=-1,p.length&&w())}function w(){if(!x){var e=f(E);x=!0;for(var t=p.length;t;){for(d=p,p=[];++g<t;)d&&d[g].run();g=-1,t=p.length}d=null,x=!1,function(e){if(c===clearTimeout)return clearTimeout(e);if((c===h||!c)&&clearTimeout)return c=clearTimeout,clearTimeout(e);try{c(e)}catch(t){try{return c.call(null,e)}catch(t){return c.call(this,e)}}}(e)}}function C(e,t){this.fun=e,this.array=t}function b(){}function O(e){if("string"!=typeof e)throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}function y(e,t){for(var n,r="",i=0,o=-1,s=0,c=0;c<=e.length;++c){if(c<e.length)n=e.charCodeAt(c);else{if(47===n)break;n=47}if(47===n){if(o===c-1||1===s);else if(o!==c-1&&2===s){if(r.length<2||2!==i||46!==r.charCodeAt(r.length-1)||46!==r.charCodeAt(r.length-2))if(r.length>2){var l=r.lastIndexOf("/");if(l!==r.length-1){-1===l?(r="",i=0):i=(r=r.slice(0,l)).length-1-r.lastIndexOf("/"),o=c,s=0;continue}}else if(2===r.length||1===r.length){r="",i=0,o=c,s=0;continue}t&&(r.length>0?r+="/..":r="..",i=2)}else r.length>0?r+="/"+e.slice(o+1,c):r=e.slice(o+1,c),i=c-o-1;o=c,s=0}else 46===n&&-1!==s?++s:s=-1}return r}u.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];p.push(new C(e,t)),1!==p.length||x||f(w)},C.prototype.run=function(){this.fun.apply(null,this.array)},u.title="browser",u.browser=!0,u.env={},u.argv=[],u.version="",u.versions={},u.on=b,u.addListener=b,u.once=b,u.off=b,u.removeListener=b,u.removeAllListeners=b,u.emit=b,u.prependListener=b,u.prependOnceListener=b,u.listeners=function(e){return[]},u.binding=function(e){throw new Error("process.binding is not supported")},u.cwd=function(){return"/"},u.chdir=function(e){throw new Error("process.chdir is not supported")},u.umask=function(){return 0};var v={resolve:function(){for(var e,t="",n=!1,r=arguments.length-1;r>=-1&&!n;r--){var i;r>=0?i=arguments[r]:(void 0===e&&(e=l.cwd()),i=e),O(i),0!==i.length&&(t=i+"/"+t,n=47===i.charCodeAt(0))}return t=y(t,!n),n?t.length>0?"/"+t:"/":t.length>0?t:"."},normalize:function(e){if(O(e),0===e.length)return".";var t=47===e.charCodeAt(0),n=47===e.charCodeAt(e.length-1);return 0!==(e=y(e,!t)).length||t||(e="."),e.length>0&&n&&(e+="/"),t?"/"+e:e},isAbsolute:function(e){return O(e),e.length>0&&47===e.charCodeAt(0)},join:function(){if(0===arguments.length)return".";for(var e,t=0;t<arguments.length;++t){var n=arguments[t];O(n),n.length>0&&(void 0===e?e=n:e+="/"+n)}return void 0===e?".":v.normalize(e)},relative:function(e,t){if(O(e),O(t),e===t)return"";if((e=v.resolve(e))===(t=v.resolve(t)))return"";for(var n=1;n<e.length&&47===e.charCodeAt(n);++n);for(var r=e.length,i=r-n,o=1;o<t.length&&47===t.charCodeAt(o);++o);for(var s=t.length-o,c=i<s?i:s,l=-1,u=0;u<=c;++u){if(u===c){if(s>c){if(47===t.charCodeAt(o+u))return t.slice(o+u+1);if(0===u)return t.slice(o+u)}else i>c&&(47===e.charCodeAt(n+u)?l=u:0===u&&(l=0));break}var a=e.charCodeAt(n+u);if(a!==t.charCodeAt(o+u))break;47===a&&(l=u)}var h="";for(u=n+l+1;u<=r;++u)u!==r&&47!==e.charCodeAt(u)||(0===h.length?h+="..":h+="/..");return h.length>0?h+t.slice(o+l):(o+=l,47===t.charCodeAt(o)&&++o,t.slice(o))},_makeLong:function(e){return e},dirname:function(e){if(O(e),0===e.length)return".";for(var t=e.charCodeAt(0),n=47===t,r=-1,i=!0,o=e.length-1;o>=1;--o)if(47===(t=e.charCodeAt(o))){if(!i){r=o;break}}else i=!1;return-1===r?n?"/":".":n&&1===r?"//":e.slice(0,r)},basename:function(e,t){if(void 0!==t&&"string"!=typeof t)throw new TypeError('"ext" argument must be a string');O(e);var n,r=0,i=-1,o=!0;if(void 0!==t&&t.length>0&&t.length<=e.length){if(t.length===e.length&&t===e)return"";var s=t.length-1,c=-1;for(n=e.length-1;n>=0;--n){var l=e.charCodeAt(n);if(47===l){if(!o){r=n+1;break}}else-1===c&&(o=!1,c=n+1),s>=0&&(l===t.charCodeAt(s)?-1==--s&&(i=n):(s=-1,i=c))}return r===i?i=c:-1===i&&(i=e.length),e.slice(r,i)}for(n=e.length-1;n>=0;--n)if(47===e.charCodeAt(n)){if(!o){r=n+1;break}}else-1===i&&(o=!1,i=n+1);return-1===i?"":e.slice(r,i)},extname:function(e){O(e);for(var t=-1,n=0,r=-1,i=!0,o=0,s=e.length-1;s>=0;--s){var c=e.charCodeAt(s);if(47!==c)-1===r&&(i=!1,r=s+1),46===c?-1===t?t=s:1!==o&&(o=1):-1!==t&&(o=-1);else if(!i){n=s+1;break}}return-1===t||-1===r||0===o||1===o&&t===r-1&&t===n+1?"":e.slice(t,r)},format:function(e){if(null===e||"object"!=typeof e)throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return function(e,t){var n=t.dir||t.root,r=t.base||(t.name||"")+(t.ext||"");return n?n===t.root?n+r:n+e+r:r}("/",e)},parse:function(e){O(e);var t={root:"",dir:"",base:"",ext:"",name:""};if(0===e.length)return t;var n,r=e.charCodeAt(0),i=47===r;i?(t.root="/",n=1):n=0;for(var o=-1,s=0,c=-1,l=!0,u=e.length-1,a=0;u>=n;--u)if(47!==(r=e.charCodeAt(u)))-1===c&&(l=!1,c=u+1),46===r?-1===o?o=u:1!==a&&(a=1):-1!==o&&(a=-1);else if(!l){s=u+1;break}return-1===o||-1===c||0===a||1===a&&o===c-1&&o===s+1?-1!==c&&(t.base=t.name=0===s&&i?e.slice(1,c):e.slice(s,c)):(0===s&&i?(t.name=e.slice(1,o),t.base=e.slice(1,c)):(t.name=e.slice(s,o),t.base=e.slice(s,c)),t.ext=e.slice(o,c)),s>0?t.dir=e.slice(0,s-1):i&&(t.dir="/"),t},sep:"/",delimiter:":",win32:null,posix:null};v.posix=v,o=v;var T,_=i("gj6Et"),k=i("4gDjz"),m=i("HLBv4"),N=i("ktaoY"),A=i("gBs5C"),S=i("ktLSh"),R={};!function(e,t){var n,r=(0,eval)("this"),o=256,s="random",c=t.pow(o,6),l=t.pow(2,52),u=2*l,a=255;function h(i,a,h){var E=[],w=x(p((a=1==a?{entropy:!0}:a||{}).entropy?[i,g(e)]:null==i?function(){try{var t;return n&&(t=n.randomBytes)?t=t(o):(t=new Uint8Array(o),(r.crypto||r.msCrypto).getRandomValues(t)),g(t)}catch(t){var i=r.navigator,s=i&&i.plugins;return[+new Date,r,s,r.screen,g(e)]}}():i,3),E),C=new f(E),b=function(){for(var e=C.g(6),t=c,n=0;e<l;)e=(e+n)*o,t*=o,n=C.g(1);for(;e>=u;)e/=2,t/=2,n>>>=1;return(e+n)/t};return b.int32=function(){return 0|C.g(4)},b.quick=function(){return C.g(4)/4294967296},b.double=b,x(g(C.S),e),(a.pass||h||function(e,n,r,i){return i&&(i.S&&d(i,C),e.state=function(){return d(C,{})}),r?(t[s]=e,n):e})(b,w,"global"in a?a.global:this==t,a.state)}function f(e){var t,n=e.length,r=this,i=0,s=r.i=r.j=0,c=r.S=[];for(n||(e=[n++]);i<o;)c[i]=i++;for(i=0;i<o;i++)c[i]=c[s=a&s+e[i%n]+(t=c[i])],c[s]=t;(r.g=function(e){for(var t,n=0,i=r.i,s=r.j,c=r.S;e--;)t=c[i=a&i+1],n=n*o+c[a&(c[i]=c[s=a&s+t])+(c[s]=t)];return r.i=i,r.j=s,n})(o)}function d(e,t){return t.i=e.i,t.j=e.j,t.S=e.S.slice(),t}function p(e,t){var n,r=[],i=typeof e;if(t&&"object"==i)for(n in e)try{r.push(p(e[n],t-1))}catch(e){}return r.length?r:"string"==i?e:e+"\0"}function x(e,t){for(var n,r=e+"",i=0;i<r.length;)t[a&i]=a&(n^=19*t[a&i])+r.charCodeAt(i++);return g(t)}function g(e){return String.fromCharCode.apply(0,e)}if(t["seed"+s]=h,x(t.random(),e),R){R=h;try{n=i("foUwZ")}catch(e){}}else"function"==typeof define&&define.amd&&define((function(){return h}))}([],Math),R.alea=_,R.xor128=k,R.xorwow=m,R.xorshift7=N,R.xor4096=A,R.tychei=S;let L=e(T=R)(null,{state:!0});function M(e){let t=[],n=0,r=0;for(let i=0;i<e.length;i++){let o=e[i];t.push(o.clone()),null===o.weight?r++:n+=o.weight}let i=(100-n)/r;for(let e=0;e<t.length;e++)null===t[e].weight&&(t[e].weight=i);return t}function B(e,t){return L()*(t-e)+e}function I(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(L()*(t-e))+e}function P(e){let t=0;for(let n of e)t+=n.weight??0;let n=0,r=B(0,t);for(let t=0;t<e.length;t++){let i=e[t];if(n+=i.weight??0,n>=r)return{choice:i.choice,choiceIndex:t}}console.warn("Unable to pick weighted choice for weights: "+e);let i=I(0,e.length);return{choice:e[i].choice,choiceIndex:i}}const U=/^\s*$/,j=/\s+$/;const K=/(\w)(\s+)([.,:;!?]+)/g;const $=/([.!?]\s+|^\s*)(\p{Ll})/gu;function W(e,t,n){return t+n.toUpperCase()}const D=/\\(\r?\n|\r)[ \t]*/g;const F={whitespaceCleanup:!0,punctuationCleanup:!0,capitalizationCleanup:!0},z={randomSeed:null,allowEval:!0};function q(e,t){return Object.assign({},e,t)}class H{constructor(e,t){this.choice=e,this.weight=t}toString(){return`WeightedChoice{choice: ${String(this.choice)}, weight: ${this.weight}}`}clone(){return new H(this.choice,this.weight)}}const Q={WeightedChoice:H,weightedChoose:P,randomInt:I,randomFloat:B};function X(e,t){let n=function(e,t){if(t>e.length)throw new Error("charIndex > string.length");let n=1,r=-1,i=!1;for(let o=0;o<=t;o++)i?(n++,r=0,i=!1):r++,"\n"===e[o]&&(i=!0);return{line:n,column:r}}(e,t);return"line: "+n.line+", column: "+n.column}function G(e){return e instanceof String||"string"==typeof e}class V extends Error{constructor(e){super(e+" This is a bug. Please report at https://github.com/ajyoon/bml/issues"),this.name="IllegalStateError",Object.setPrototypeOf(this,V.prototype)}}class Z extends Error{constructor(e,t){super("Syntax error found while parsing bml javascript at "+X(e,t)),this.name="JavascriptSyntaxError",Object.setPrototypeOf(this,Z.prototype)}}class J extends Error{constructor(e,t,n,r){let i=(e||"Syntax error found while parsing bml")+" at "+X(t,n);r&&(i+="\n"+r),super(i),this.name="BMLSyntaxError",Object.setPrototypeOf(this,J.prototype)}}class Y extends Error{constructor(e,t,n,r){super(`Duplicated reference index ${t} for reference ${e} at ${X(n,r)}`),this.name="BMLDuplicatedRefIndexError",Object.setPrototypeOf(this,Y.prototype)}}class ee extends Error{constructor(e,t,n){super(`Duplicated reference ${e} at ${X(t,n)}`),this.name="BMLDuplicatedRefError",Object.setPrototypeOf(this,ee.prototype)}}class te extends Error{constructor(e,t){super(`Eval binding of settings field '${e}' of '${t}' is invalid`),this.name="EvalBoundSettingsError",Object.setPrototypeOf(this,te.prototype)}}class ne extends Error{constructor(e){super(`Eval binding ${e} was bound multiple times.`),this.name="EvalBindingError",Object.setPrototypeOf(this,ne.prototype)}}class re extends Error{constructor(){super("This document includes eval blocks and cannot be rendered with allowEval=false."),this.name="EvalDisabledError",Object.setPrototypeOf(this,re.prototype)}}class ie extends Error{constructor(e,t){super(`Include failed for '${e}': ${t}`),this.name="IncludeError",Object.setPrototypeOf(this,ie.prototype)}}function oe(e,t,n){const r=e[t];if(null!=r&&typeof r!==n)throw new te("setting."+t,r)}function se(e){let t=e.settings;t&&(oe(t,"whitespaceCleanup","boolean"),oe(t,"punctuationCleanup","boolean"),oe(t,"capitalizationCleanup","boolean"))}const ce="\n  const bml = this;\n\n  const __new_bindings = {};\n\n  function bind(obj) {\n    for (let key in obj) {\n      __new_bindings[key] = obj[key];\n    }\n  }\n\n  // Note this feature is currently unstable. The final structure of forkMap\n  // is likely to change before stabilizing.\n  bml.forkMap = __context.renderer.choiceResultMap;\n\n  ***USER DEFS BINDING SLOT***\n\n\n  function insert(str) {\n    __context.output += str;\n  }\n\n  function include(includePath) {\n    let result = __context.renderer.renderInclude(includePath);\n    insert(result);\n  }\n\n  ////////// start user code\n\n  ***USER CODE SLOT***\n\n  ////////// end user code\n\n  ***SAVE USER MUTATIONS SLOT***\n\n  return __new_bindings;\n";class le{constructor(e){this.contents=e}toString(){return`EvalBlock('${this.contents}')`}generateBindingCode(e){let t=[];e.settings&&t.push("let settings = __context.bindings.settings;");for(let n in e)t.push(`let ${n} = __context.bindings.${n}`);return t.join("\n")}generateSaveUserMutationsCode(e){let t=[];e.settings&&t.push("__context.bindings.settings = settings;");for(let n in e)t.push(`__context.bindings.${n} = ${n};`);return t.join("\n")}toFunc(e){let t=ce.replace("***USER CODE SLOT***",this.contents);t=t.replace("***USER DEFS BINDING SLOT***",this.generateBindingCode(e)),t=t.replace("***SAVE USER MUTATIONS SLOT***",this.generateSaveUserMutationsCode(e));let n=Object.assign({},Q);return new Function("__context",t).bind(n)}execute(e){let t=this.toFunc(e.bindings)(e);se(t);for(let[n,r]of Object.entries(t)){if(e.bindings.hasOwnProperty(n))throw new ne(n);e.bindings[n]=r}}}let ue;var ae;(ae=ue||(ue={})).WHITESPACE="WHITESPACE",ae.NEW_LINE="NEW_LINE",ae.VISUAL_NEW_LINE="VISUAL_NEW_LINE",ae.COMMENT="COMMENT",ae.OPEN_BLOCK_COMMENT="OPEN_BLOCK_COMMENT",ae.CLOSE_BLOCK_COMMENT="CLOSE_BLOCK_COMMENT",ae.SLASH="SLASH",ae.SINGLE_QUOTE="SINGLE_QUOTE",ae.DOUBLE_QUOTE="DOUBLE_QUOTE",ae.BACKTICK="BACKTICK",ae.OPEN_PAREN="OPEN_PAREN",ae.CLOSE_PAREN="CLOSE_PAREN",ae.OPEN_BRACE="OPEN_BRACE",ae.CLOSE_BRACE="CLOSE_BRACE",ae.OPEN_BRACKET="OPEN_BRACKET",ae.CLOSE_BRACKET="CLOSE_BRACKET",ae.COMMA="COMMA",ae.COLON="COLON",ae.AT="AT",ae.ARROW="ARROW",ae.NUMBER="NUMBER",ae.TEXT="TEXT";class he{constructor(e,t,n){this.weights=M(e),this.identifier=t,this.isSilent=n}call(){let e=P(this.weights);return{replacement:e.choice,choiceIndex:e.choiceIndex}}toString(){return`ChoiceFork{weights: ${this.weights}, identifier: ${this.identifier}, isSilent: ${this.isSilent}}`}}class fe{constructor(e,t,n){this.id=e,this.referenceMap=t,n.length?this.fallbackChoiceFork=new he(n,null,!1):this.fallbackChoiceFork=null}}function de(e){if(e.next()?.tokenType!==ue.OPEN_BRACKET)throw new V("parseEval started with non-OPEN_BRACKET");let t,n="code",r=e.index,i=1;for(;null!==(t=e.next());)switch(n){case"block comment":t.tokenType===ue.CLOSE_BLOCK_COMMENT&&(n="code");break;case"inline comment":t.tokenType===ue.NEW_LINE&&(n="code");break;case"template literal":t.tokenType===ue.BACKTICK&&(n="code");break;case"single-quote string":if(t.tokenType===ue.SINGLE_QUOTE)n="code";else if(t.tokenType===ue.NEW_LINE)throw new Z(e.str,e.index);break;case"double-quote string":if(t.tokenType===ue.DOUBLE_QUOTE)n="code";else if(t.tokenType===ue.NEW_LINE)throw new Z(e.str,e.index);break;case"regexp literal":t.tokenType===ue.SLASH&&(n="code");break;case"code":switch(t.tokenType){case ue.OPEN_BRACKET:i++;break;case ue.CLOSE_BRACKET:if(i--,i<1){let t=e.str.slice(r,e.index-1);return new le(t)}break;case ue.COMMENT:n="inline comment";break;case ue.OPEN_BLOCK_COMMENT:n="block comment";break;case ue.BACKTICK:n="template literal";break;case ue.SINGLE_QUOTE:n="single-quote string";break;case ue.DOUBLE_QUOTE:n="double-quote string";break;case ue.SLASH:n="regexp literal"}break;default:throw new Error(`Invalid state: ${n}`)}throw new Z("could not find end of javascript code block",r)}function pe(e){let t,n=e.index,r=new Map,i=[],o=/([@#]?)([_a-zA-Z\xA0-\uFFFF][_a-zA-Z0-9\xA0-\uFFFF]*)(:?)/y,s=null,c=!1,l=!1,u=!0,a=!1,h=!1,f=!1,d=!0,p=!1,x=!1,g=[],E=null;for(;null!==(t=e.peek());){switch(t.tokenType){case ue.WHITESPACE:case ue.NEW_LINE:break;case ue.NUMBER:if(h)h=!1,f=!0,p=!0,x=!1,g.push(Number(t.str));else{if(!a)throw new J("Unexpected number in fork",e.str,t.index);a=!1,p=!0,x=!0,i[i.length-1].weight=Number(t.str)}break;case ue.ARROW:if(!f)throw new J("Unexpected arrow in fork",e.str,t.index);f=!1,d=!0,p=!1;break;case ue.OPEN_PAREN:case ue.OPEN_BRACKET:case ue.OPEN_BRACE:if(!d)throw new J("Unexpected replacement in fork",e.str,t.index);if(h=!1,t.tokenType===ue.OPEN_PAREN?(e.next(),E=ge(e,!1)):t.tokenType===ue.OPEN_BRACKET?E=de(e):(e.next(),E=[pe(e)]),g.length){for(let n of g){if(r.has(n))throw new Y(s,n,e.str,t.index);r.set(n,E)}d=!1,p=!0,x=!0,g=[],E=null}else i.push(new H(E,null)),d=!1,p=!0,a=!0,x=!0;continue;case ue.COMMA:if(!p)throw new J("Unexpected comma in fork",e.str,t.index);p=!1,h=!0,f||(d=!0);break;case ue.CLOSE_BRACE:if(x)return e.next(),c?new fe(s,r,i):new he(i,s,l);if(!r.size&&!i.length)throw s?new J(`Fork '${s}' has no branches`,e.str,t.index,`Did you mean '{@${s}}'?`):new J("Fork has no branches",e.str,t.index);throw new J("Unexpected close brace in fork",e.str,t.index);case ue.TEXT:case ue.AT:if(u){o.lastIndex=e.index;let n=o.exec(e.str);if(!n)throw new J(`Unexpected token ${t}`,e.str,t.index);let r=n[1];s=n[2];let i=!!n[3];"@"==r?(c=!0,i?h=!0:x=!0):"#"==r&&(l=!0),e.overrideIndex(e.index+n[0].length),u=!1;continue}throw new J(`Unexpected token ${t}`,e.str,t.index);default:throw new J(`Unexpected token ${t}`,e.str,t.index)}e.next()}throw new J("Could not find end of fork.",e.str,n)}function xe(e){let t,n=e.index-1;if(e.next()?.tokenType!==ue.OPEN_BRACKET)throw new V("parseLiteralBlock started with non-OPEN_BRACKET");let r="";for(;null!==(t=e.next());){if(t.tokenType===ue.CLOSE_BRACKET&&e.peek()?.tokenType==ue.CLOSE_BRACKET)return e.next(),r;r+=t.str}throw new J("Could not find end of literal block",e.str,n)}function ge(e,t){let n,r=e.index,i=1,o=[];function s(e){if(!o.length)return void o.push(e);let t=o[o.length-1];G(t)?o[o.length-1]=t.concat(e):o.push(e)}for(;null!==(n=e.next());)switch(n.tokenType){case ue.OPEN_PAREN:i++,s(n.str);break;case ue.CLOSE_PAREN:if(i--,i<1)return o;s(n.str);break;case ue.OPEN_BRACKET:e.peek()?.tokenType==ue.OPEN_BRACKET?s(xe(e)):s(n.str);break;case ue.OPEN_BRACE:let t=pe(e);o=o.concat(t);break;default:s(n.str)}if(!t)throw new J("Reached end of document while parsing string.",e.str,r);return o}class Ee{constructor(e,t,n,r){this.tokenType=e,this.index=t,this.endIndex=n,this.str=r}toString(){return`Token{tokenType: ${this.tokenType}, index: ${this.index}, endIndex: ${this.endIndex}, string: '${this.str}'}`}}const we=/\s/;class Ce{_cachedNext=null;_newLineRe=/\r?\n/y;_whitespaceRe=/[^\S\r\n]+/y;_numberRe=/(\d+(\.\d+)?)|(\.\d+)/y;constructor(e){this.str=e,this.index=0}overrideIndex(e){this._cachedNext=null,this.index=e}_determineNextRaw(){if(this.index>=this.str.length)return null;let e,t,n=this.index,r=null;this._newLineRe.lastIndex=this.index,this._whitespaceRe.lastIndex=this.index,this._numberRe.lastIndex=this.index;let i=this._newLineRe.exec(this.str),o=this._whitespaceRe.exec(this.str),s=this._numberRe.exec(this.str);if(null!==i)e=ue.NEW_LINE,t=i[0];else if(null!==o)e=ue.WHITESPACE,t=o[0];else if(null!==s)e=ue.NUMBER,t=s[0];else if("//"===this.str.slice(this.index,this.index+2))e=ue.COMMENT,t="//";else if("/*"===this.str.slice(this.index,this.index+2))e=ue.OPEN_BLOCK_COMMENT,t="/*";else if("*/"===this.str.slice(this.index,this.index+2))e=ue.CLOSE_BLOCK_COMMENT,t="*/";else if("/"===this.str[this.index])e=ue.SLASH,t="/";else if("'"===this.str[this.index])e=ue.SINGLE_QUOTE,t="'";else if('"'===this.str[this.index])e=ue.DOUBLE_QUOTE,t='"';else if("`"===this.str[this.index])e=ue.BACKTICK,t="`";else if("("===this.str[this.index])e=ue.OPEN_PAREN,t="(";else if(")"===this.str[this.index])e=ue.CLOSE_PAREN,t=")";else if("{"===this.str[this.index])e=ue.OPEN_BRACE,t="{";else if("}"===this.str[this.index])e=ue.CLOSE_BRACE,t="}";else if(","===this.str[this.index])e=ue.COMMA,t=",";else if(":"===this.str[this.index])e=ue.COLON,t=":";else if("@"===this.str[this.index])e=ue.AT,t="@";else if("["===this.str[this.index])e=ue.OPEN_BRACKET,t="[";else if("]"===this.str[this.index])e=ue.CLOSE_BRACKET,t="]";else if("->"===this.str.slice(this.index,this.index+2))e=ue.ARROW,t="->";else if(e=ue.TEXT,"\\"===this.str[this.index]){let e=this.str[this.index+1];"\\/[{])".includes(e)?(r=this.index+2,t=e):"n"===e?(r=this.index+2,t="\n"):"t"===e?(r=this.index+2,t="\t"):"r"===e?(r=this.index+2,t="\r"):t="\\"}else t=this.str[this.index];return null===r&&(r=n+t.length),new Ee(e,n,r,t)}_determineNextReal(){let e,t=!1,n=!1,r=this.index;for(;null!==(e=this._determineNextRaw());){if(t){if(e.tokenType===ue.NEW_LINE)return t=!1,new Ee(ue.NEW_LINE,e.index,e.endIndex,e.str)}else if(n){if(e.tokenType===ue.CLOSE_BLOCK_COMMENT){let t=e.index+1;return new Ee(ue.WHITESPACE,t,t+1," ")}}else if(e.tokenType===ue.COMMENT){let n=e.index>=this.str.length||we.test(this.str[e.endIndex]);if(!(0===e.index||we.test(this.str[e.index-1]))&&!n)return new Ee(ue.TEXT,e.index,e.endIndex,e.str);t=!0}else{if(e.tokenType!==ue.OPEN_BLOCK_COMMENT)return this.index=r,e;n=!0}this.index=e.endIndex}return this.index=r,null}next(){let e;return null!==this._cachedNext?(e=this._cachedNext,this._cachedNext=null):e=this._determineNextReal(),this.index=null!==e?e.endIndex:this.str.length,e}peek(){if(null!==this._cachedNext)return this._cachedNext;let e=this._determineNextReal();return this._cachedNext=e,e}nextSatisfying(e){let t;for(;null!==(t=this.next());)if(e(t))return t;return null}nextNonWhitespace(){return this.nextSatisfying((e=>e.tokenType!==ue.WHITESPACE&&e.tokenType!==ue.NEW_LINE))}}var be=i("foUwZ");class Oe{constructor(e,t){this.settings=e,this.choiceResultMap=new Map,this.evalContext={bindings:{},output:"",renderer:this},this.documentDir=t}resolveReference(e){let t=this.choiceResultMap.get(e.id);if(t){if(!e.referenceMap.size&&!e.fallbackChoiceFork)return[t.renderedOutput];let n=e.referenceMap.get(t.choiceIndex);if(void 0!==n)return n}return e.fallbackChoiceFork?e.fallbackChoiceFork.call().replacement:(console.warn(`No matching reference or fallback found for ${e.id}`),[""])}renderChoice(e){if(e instanceof Array)return this.renderAst(e);{if(!this.settings.allowEval)throw new re;e.execute(this.evalContext);let t=this.evalContext.output;return this.evalContext.output="",t}}renderAst(e){let t="";for(let n=0;n<e.length;n++){let r=e[n];if(G(r))t+=r;else if(r instanceof he){let{replacement:i,choiceIndex:o}=r.call(),s=this.renderChoice(i);if(r.isSilent){if(t.length&&"\n"==t[t.length-1]){let t=n<e.length-1?e[n+1]:null;G(t)&&(t.startsWith("\n")?e[n+1]=t.slice(1):t.startsWith("\r\n")&&(e[n+1]=t.slice(2)))}}else t+=s;r.identifier&&this.choiceResultMap.set(r.identifier,{choiceIndex:o,renderedOutput:s})}else{let e=this.resolveReference(r);t+=this.renderChoice(e)}}return t}postprocess(e){let t=q(F,this.evalContext.bindings.settings),n=e;return n=function(e){return e.replace(D," ")}(n),t.punctuationCleanup&&(n=function(e){return e.replace(K,"$1$3$2")}(n)),t.capitalizationCleanup&&(n=function(e){return e.replace($,W)}(n)),t.whitespaceCleanup&&(n=function(e){let t="",n=!0,r=!1;for(let i of e.split("\n")){let e=U.test(i);if(n){if(e)continue;n=!1}if(e){if(r)continue;i=""}else{i=i.replace(j,"");let e="",t=!0,n=!1;for(let r of i){let i=" "===r;!t&&n&&i||(i||(t=!1),e+=r,n=i)}i=e}r=e,t+=i+"\n"}return t.endsWith("\n\n")&&(t=t.substring(0,t.length-1)),t}(n)),n}renderWithoutPostProcess(t){var n;return this.settings.randomSeed&&(n=this.settings.randomSeed,L=e(T)(n,{state:!0})),this.renderAst(t)}renderAndPostProcess(e){return this.postprocess(this.renderWithoutPostProcess(e))}renderInclude(t){let n,r=L.state();try{n=function(t,n){if(n){if(!e(be).lstatSync(n).isDirectory())throw new Error;t=e(o).join(n,t)}if(!e(be).existsSync(t))throw new Error;return""+e(be).readFileSync(t)}(t,this.documentDir)}catch(e){if("undefined"!=typeof window)throw new ie(t,"Includes can't be used in browsers");throw e}let i=ge(new Ce(n),!0),s=new Oe(this.settings,e(o).dirname(t)),c=s.renderWithoutPostProcess(i);for(let[e,n]of Object.entries(s.evalContext.bindings)){if(this.evalContext.bindings.hasOwnProperty(e))throw new ie(t,`Eval binding '${e}' is already bound`);this.evalContext.bindings[e]=n}for(let[e,n]of s.choiceResultMap){if(this.choiceResultMap.has(e))throw new ie(t,`Fork id '${e}' is already defined`);this.choiceResultMap.set(e,n)}var l;return l=r,L=e(T)(null,{state:l}),c}}class ye{}class ve extends ye{referencedBy=[];constructor(e=null,t=[]){super(),this.id=e,this.branches=t}countOutcomes(){let e=BigInt(0);for(let t of this.branches)e+=_e(t);for(let t of this.referencedBy)e+=t.countOutcomesAddedToReferredNode();return e}}class Te extends ye{constructor(e,t){super(),this.forkNodeReferredTo=e,this.referenceMap=t}countOutcomesAddedToReferredNode(){let e=BigInt(0);for(let[t,n]of this.referenceMap.entries())e+=_e(n)-BigInt(1);return e}}function _e(e){let t=BigInt(1);for(let n of e)n instanceof ve&&(t*=n.countOutcomes());return t}function ke(e,t){let n=new ve(e.identifier,[]);n.id&&t.set(n.id,[n,e]);for(let r of e.weights){let e=r.choice;if(e instanceof le)n.branches.push([]);else{let r=Ne(e,t);n.branches.push(r)}}return n}function me(e,t){let n=t.get(e.id)[0],r=new Te(n,new Map);n.referencedBy.push(r);for(let[n,i]of e.referenceMap.entries()){let e;if(i instanceof le)e=[];else{e=Ne(i,t)}r.referenceMap.set(n,e)}if(e.fallbackChoiceFork){let n=ke(e.fallbackChoiceFork,t),i=t.get(e.id)[1];for(let e=0;e<i.weights.length;e++)r.referenceMap.has(e)||r.referenceMap.set(e,[n])}return r}function Ne(e,t){let n=[];for(let r of e)r instanceof he?n.push(ke(r,t)):r instanceof fe&&n.push(me(r,t));return n}window.bml=function(e,t,n){t=q(z,t);let r=ge(new Ce(e),!0);return new Oe(t,n).renderAndPostProcess(r)},window.bml.analyze=function(e){return{possibleOutcomes:_e(Ne(ge(new Ce(e),!0),new Map))}}})();
//# sourceMappingURL=bml.bundle.js.map
